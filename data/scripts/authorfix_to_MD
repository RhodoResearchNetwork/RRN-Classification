import os
import re
import yaml

# Configuration
target_dir = "monograph_md"
pattern = r"\bBalfour f. & W.W.Sm.\b"
replacement = "Balf.f. & W.W.Sm."

def process_file(path):
    with open(path, "r", encoding="utf-8") as f:
        lines = f.readlines()

    if lines[0].strip() != "---":
        return  # Skip files without YAML frontmatter

    # Extract YAML block
    frontmatter = []
    for i, line in enumerate(lines[1:], start=1):
        if line.strip() == "---":
            end_index = i
            break
        frontmatter.append(line)
    else:
        return  # No closing delimiter

    try:
        yaml_data = yaml.safe_load("".join(frontmatter))
    except yaml.YAMLError:
        print(f"! Skipped (invalid YAML): {path}")
        return

    # Modify 'scientificname' field
    if "scientificname" in yaml_data:
        original = yaml_data["scientificname"]
        updated = re.sub(pattern, replacement, original)
        if original != updated:
            yaml_data["scientificname"] = updated
            # Rewrite YAML block
            new_yaml = yaml.dump(yaml_data, sort_keys=False).strip().splitlines()
            lines = ["---\n"] + [line + "\n" for line in new_yaml] + ["---\n"] + lines[end_index+1:]
            with open(path, "w", encoding="utf-8") as f:
                f.writelines(lines)
            print(f"âœ“ Updated: {os.path.basename(path)}")

def scan_directory(directory):
    for root, _, files in os.walk(directory):
        for file in files:
            if file.endswith(".md"):
                process_file(os.path.join(root, file))

# Go!
scan_directory(target_dir)